# Development Plan

## Quality Gate Expectations
- `ruff format`, `ruff check`, `mypy`, and `pytest -q` form the mandatory pre-PR sequence, matching the guidance captured in README.【F:README.md†L28-L68】
- New documentation must cite authoritative evidence (tests, scripts, or source files) as demonstrated in README and `docs/markdown_compliance_review.md` so reviewers can audit the Platinum uplift quickly.【F:README.md†L320-L372】【F:docs/markdown_compliance_review.md†L1-L120】

## Outstanding Failures and Opportunities
- `mypy custom_components/pawcontrol` still raises 400+ errors across compatibility layers, coordinators, and service helpers. Stage the recovery so we unblock Platinum linting without destabilising runtime behaviour:
  1. **Foundation pass (complete)** – the compatibility modules and cache helpers now type-check in isolation, and the `coordinator_support`/`person_entity_manager` Protocol exports provide concrete Home Assistant types for downstream modules. Begin the coordinator/service sweep next so runtime entry points match the tightened cache semantics.【0dd412†L1-L55】【bb4d36†L1-L120】
  2. **Coordinator/service sweep (in progress)** – `data_manager.async_export_data` now delegates to the shared history helper so service exports inherit the same window semantics, cache monitor registration documents the coordinator diagnostics contract, and all coordinator module adapters expose typed payloads consumed by the runtime; aggregated cache metrics feed Home Assistant repairs, daily services capture typed diagnostics, coordinator statistics surface condensed repair severity counters, garden/grooming services emit structured telemetry with documentation updates, garden automation fallbacks plus grooming reminder metadata now flow through the typed service telemetry, and both the daily reset plus hourly maintenance utilities emit structured diagnostics for repairs dashboards. Reconfigure telemetry summaries now sync into runtime performance stats, surface through coordinator diagnostics, and ride along daily-reset metadata so we can broaden the mypy gate with confidence.【F:custom_components/pawcontrol/services.py†L4086-L4184】【F:custom_components/pawcontrol/coordinator_tasks.py†L22-L140】【F:custom_components/pawcontrol/telemetry.py†L1-L124】
  3. **UI/config flows (in progress)** – `config_flow.py` and `config_flow_dogs.py` expose TypedDict-backed discovery payloads, dog validation caches, and health/feeding telemetry structures; the options flow normalises geofence, notification, performance, weather, feeding, health, system, dashboard, advanced, GPS, and per-dog overrides with targeted tests. Module, dashboard, and external-entity mixins now rely on the shared TypedDicts for global settings, dashboard preferences, feeding defaults, and external mappings so configuration state stays typed end-to-end. Reconfigure telemetry now feeds the options profile placeholders, raises repair issues, and ships regression tests guarding the translation placeholders, and the CI mypy gate covers `repairs.py`, `types.py`, and the coordinator/service telemetry stack while we stage broader enforcement across the integration.【F:custom_components/pawcontrol/config_flow.py†L1888-L2036】【F:custom_components/pawcontrol/options_flow.py†L120-L520】【F:custom_components/pawcontrol/repairs.py†L200-L420】【F:tests/unit/test_translation_placeholders.py†L1-L66】【F:.github/workflows/ci.yml†L141-L210】
- Expand cache monitoring—the entity budget tracker and coordinator module caches now register with the data manager monitor; diagnostics exports surface notification/person cache snapshots, and the storage/helper manager namespaces now auto-register both at boot and when runtime data becomes available. Script and door-sensor managers now publish per-dog diagnostics, timestamp thresholds have been tightened (36-hour staleness / 2-minute future guardrails), and cache anomaly detection extends to script generations plus door-sensor activity snapshots so repairs can highlight stale automation telemetry. Follow-up: validate the tuned thresholds against nightly telemetry, extend anomaly detection to persistence namespaces beyond door sensors if new storage surfaces appear, and compare the new cache metrics with real walk automation workloads to refine the heuristics.【F:custom_components/pawcontrol/data_manager.py†L480-L560】【F:custom_components/pawcontrol/script_manager.py†L20-L220】【F:custom_components/pawcontrol/door_sensor_manager.py†L40-L220】【F:custom_components/pawcontrol/diagnostics.py†L204-L360】
- Monitor the Adaptive/Optimized cache overrides in daily coordinator jobs now that override-aware pruning is in place; expose diagnostics so coordinators can surface anomalies when field logs highlight edge cases beyond the new unit coverage.【F:custom_components/pawcontrol/data_manager.py†L98-L190】【F:custom_components/pawcontrol/helpers.py†L120-L240】

## Action Items
1. Capture the current `ruff` and `pytest` results, filing regressions under “Outstanding Failures and Opportunities”. `ruff check` is green and `pytest -q` succeeds after the cache eviction updates.【d0705c†L1-L2】【9ef534†L1-L13】
2. Keep `python -m script.hassfest --integration-path custom_components/pawcontrol` in the pre-PR checklist so manifest regressions surface locally before CI.
3. Land the remaining foundation-pass typing patches (`coordinator_support`, `person_entity_manager`) before beginning the coordinator/service sweep so we avoid regressing the new cache diagnostics hooks.
4. Expand removal/troubleshooting guidance in `INSTALLATION.md` and `info.md` after the device removal tests pass to keep Markdown aligned with runtime behaviour.【F:docs/markdown_compliance_review.md†L1-L120】
5. Keep `.github/copilot-instructions.md`, `.gemini/styleguide.md`, and `.claude/agents/copilot-instructions.md` aligned when requirements change so assistant guidance does not drift.【F:.github/copilot-instructions.md†L1-L92】【F:.gemini/styleguide.md†L1-L26】【F:.claude/agents/copilot-instructions.md†L1-L8】
6. Instrument notification caches and performance trackers with lightweight diagnostics so coordinator snapshots highlight rate limiting and entity saturation regressions before deployment.
7. Monitor the cache health repairs telemetry for noisy thresholds, verify the garden/grooming telemetry snapshots during nightly jobs, confirm the new garden automation fallback and grooming reminder metadata produces actionable coordinator repair counters, and audit the new reconfigure summary metadata after nightly resets.【F:custom_components/pawcontrol/services.py†L2860-L3220】【F:custom_components/pawcontrol/repairs.py†L200-L260】【F:custom_components/pawcontrol/coordinator_tasks.py†L22-L140】【F:custom_components/pawcontrol/telemetry.py†L1-L124】
8. Exercise the typed config-flow mixins with dedicated regression tests (global settings, dashboard templates, external entity validation) so the new TypedDict plumbing remains stable under nightly telemetry updates.【F:custom_components/pawcontrol/config_flow_modules.py†L200-L660】【F:tests/unit/test_options_flow.py†L320-L480】
9. Monitor the expanded config-flow mypy gate (now covering the shared base/profile mixins), review nightly telemetry for the new reauth and reconfigure diagnostics, and scope the remaining configuration mixins that still need typed fixtures before broadening the CI gate.【F:.github/workflows/ci.yml†L150-L207】【F:custom_components/pawcontrol/config_flow_base.py†L1-L200】【F:custom_components/pawcontrol/config_flow.py†L1888-L2036】
10. Validate the new reconfigure telemetry repairs issues against nightly data, monitor the coordinator/service summaries for regressions, then plan the next wave of mypy coverage for modules beyond the telemetry stack so the broadened CI gate keeps catching regressions early.【F:custom_components/pawcontrol/repairs.py†L200-L360】【F:tests/test_repairs.py†L720-L900】【F:.github/workflows/ci.yml†L141-L210】
11. Perform UI verification (or snapshot coverage) of the entity profile placeholders across locales now that regression tests enforce translation placeholders, and confirm severity tuning for the reconfigure repairs issues once telemetry is available.【F:custom_components/pawcontrol/options_flow.py†L120-L360】【F:tests/unit/test_translation_placeholders.py†L1-L66】【F:custom_components/pawcontrol/repairs.py†L360-L520】
12. Validate the storage namespace and helper/helper-manager cache monitors against nightly telemetry, refine the timestamp anomaly thresholds now that storage diagnostics surface missing/future entries, and exercise the new script/door-sensor cache monitors under real workloads before broadening the mypy gate to the remaining coordinator modules. Include runtime re-registration checks so monitors stay attached after config flow reloads.【F:custom_components/pawcontrol/data_manager.py†L1030-L1310】【F:custom_components/pawcontrol/helper_manager.py†L40-L240】【F:custom_components/pawcontrol/door_sensor_manager.py†L160-L360】【F:custom_components/pawcontrol/script_manager.py†L20-L220】【F:tests/unit/test_data_manager.py†L200-L520】

## Recently Addressed
- README now documents the Platinum uplift, quality gates, and documentation traceability so contributors follow the same compliance baseline.【F:README.md†L1-L199】【F:README.md†L320-L380】
- `docs/compliance_gap_analysis.md` and `docs/markdown_compliance_review.md` provide auditable mappings from Home Assistant requirements to repository evidence, satisfying the instruction sets from Copilot, Gemini, and Claude.【F:docs/compliance_gap_analysis.md†L1-L120】【F:docs/markdown_compliance_review.md†L1-L120】
- Adaptive and Optimized cache tests now cover override-aware eviction, and the caches expose coordinator-ready snapshots so metrics sinks can capture override anomalies during runtime.【F:tests/unit/test_adaptive_cache.py†L205-L320】【F:custom_components/pawcontrol/data_manager.py†L180-L220】【F:custom_components/pawcontrol/helpers.py†L320-L360】
- Hassfest validation can now be executed via `python -m script.hassfest` after adding the missing entry point shim, restoring parity with Home Assistant’s tooling expectations.【F:script/hassfest/__main__.py†L1-L98】
- Coordinator cache monitors now include entity budget snapshots and per-module cache metrics, with unit coverage guaranteeing diagnostics stay stable as additional caches register.【F:custom_components/pawcontrol/data_manager.py†L720-L860】【F:tests/unit/test_data_manager.py†L1-L220】
- Notification and person targeting caches now register with the diagnostics monitor via the coordinator binding path, and dedicated unit coverage exercises the registrar handshake for Platinum-grade observability.【F:custom_components/pawcontrol/coordinator_support.py†L120-L220】【F:custom_components/pawcontrol/notifications.py†L420-L520】【F:tests/unit/test_data_manager.py†L200-L340】
- Data manager module history retrieval now provides limit and window filtering for analytics callers while new unit coverage exercises weekly reporting and comprehensive pattern analysis paths.【F:custom_components/pawcontrol/data_manager.py†L1108-L1194】【F:custom_components/pawcontrol/data_manager.py†L1388-L1496】【F:tests/unit/test_data_manager.py†L200-L320】
- Export workflows now reuse the shared history helper, preserving chronological ordering for feeding data and respecting medication windows while dedicated unit coverage guards the regression surface.【F:custom_components/pawcontrol/data_manager.py†L1556-L1655】【F:tests/unit/test_data_manager.py†L332-L480】
- Coordinator module adapters now expose typed payloads and the runtime consumes the union so the service sweep can focus on diagnostics coverage next.【F:custom_components/pawcontrol/module_adapters.py†L160-L780】【F:custom_components/pawcontrol/coordinator_runtime.py†L410-L456】
- Daily reset services now capture typed cache diagnostics snapshots with repair summaries and dedicated unit tests cover the helper along with the reset flow to guard the coordinator/service sweep.【F:custom_components/pawcontrol/services.py†L250-L360】【F:tests/unit/test_services.py†L1-L220】
- Service handlers for feeding analytics, health exports, automation, and notification flows now emit structured telemetry entries so runtime performance stats expose success/error metadata alongside cache diagnostics, backed by unit coverage that exercises both success and failure capture paths.【F:custom_components/pawcontrol/services.py†L1000-L2060】【F:tests/unit/test_services.py†L80-L620】
- Garden, grooming, health-snack, and poop logging services now publish typed telemetry payloads, surface validation errors in service messages, and include comprehensive unit coverage verifying both success and failure scenarios along with updated service documentation references.【F:custom_components/pawcontrol/services.py†L2860-L3220】【F:tests/unit/test_services.py†L620-L1010】【F:docs/comprehensive_readme.md†L260-L296】
- Garden automation fallbacks and grooming reminder telemetry now enrich service metadata, documentation, and tests so diagnostics capture the triggering automation context for nightly repairs dashboards.【F:custom_components/pawcontrol/services.py†L2970-L3180】【F:tests/unit/test_services.py†L880-L1016】【F:docs/comprehensive_readme.md†L260-L296】【F:custom_components/pawcontrol/services.yaml†L520-L720】
- Config flows now persist typed discovery payloads, validation caches, and health/feeding telemetry structures so setup paths align with the Platinum typing plan.【F:custom_components/pawcontrol/config_flow.py†L1-L360】【F:custom_components/pawcontrol/config_flow_dogs.py†L900-L1500】【F:custom_components/pawcontrol/types.py†L60-L220】
- Config-flow validation caching now records typed timestamps and state signatures so the primary config flow passes isolated mypy checks while sharing metadata with the dog-management mixin and future options-flow reuse.【F:custom_components/pawcontrol/config_flow.py†L760-L820】【F:custom_components/pawcontrol/types.py†L488-L520】
- The shared config-flow base/profile mixins now type-check in isolation and are enforced by the CI mypy gate so foundational setup helpers stay aligned with the TypedDict-backed flows.【F:custom_components/pawcontrol/config_flow_base.py†L1-L200】【F:custom_components/pawcontrol/config_flow_profile.py†L1-L200】【F:.github/workflows/ci.yml†L150-L172】
- Options flow now persists typed GPS configuration and per-dog module overrides while unit coverage guards the new diagnostics-rich menus.【F:custom_components/pawcontrol/options_flow.py†L1860-L2260】【F:tests/unit/test_options_flow.py†L360-L480】
- Options flow now exposes JSON import/export utilities with typed payloads and regression tests covering both export and import paths.【F:custom_components/pawcontrol/options_flow.py†L3180-L3280】【F:tests/unit/test_options_flow.py†L480-L580】
- Reauthentication now records typed health summaries, sanitises diagnostics before persistence, and the options import helpers validate module payloads and duplicate dog IDs with dedicated regression coverage.【F:custom_components/pawcontrol/config_flow.py†L1390-L1700】【F:custom_components/pawcontrol/options_flow.py†L200-L360】【F:tests/components/pawcontrol/test_config_flow.py†L300-L460】【F:tests/unit/test_options_flow.py†L480-L620】
- Reconfigure now surfaces typed telemetry (profile compatibility, health summaries, entity counts) with regression coverage asserting both success and warning paths.【F:custom_components/pawcontrol/config_flow.py†L1888-L2036】【F:tests/components/pawcontrol/test_config_flow.py†L220-L360】【F:tests/components/pawcontrol/test_config_flow.py†L600-L700】
- GitHub Actions now enforces a config-flow mypy gate that runs `mypy --follow-imports=skip` against the typed configuration modules so regressions surface before merge.【F:.github/workflows/ci.yml†L141-L207】
- Reconfigure telemetry now powers the options profile placeholders, emits repair issues for compatibility and health anomalies, and the CI mypy gate was expanded to cover `repairs.py`, `types.py`, and the coordinator/service telemetry modules for early regression detection.【F:custom_components/pawcontrol/options_flow.py†L120-L1320】【F:custom_components/pawcontrol/repairs.py†L200-L420】【F:.github/workflows/ci.yml†L141-L210】【F:tests/test_repairs.py†L720-L900】
- Coordinator and service pipelines now ingest reconfigure telemetry summaries, persist them in runtime performance stats, and expose the data through diagnostics with dedicated unit coverage.【F:custom_components/pawcontrol/coordinator_tasks.py†L22-L140】【F:custom_components/pawcontrol/services.py†L4086-L4184】【F:custom_components/pawcontrol/telemetry.py†L1-L124】【F:tests/unit/test_services.py†L430-L620】【F:tests/unit/test_coordinator_tasks.py†L1-L220】
- Translation placeholders for the reconfigure repairs now have regression coverage so localisation changes cannot drop required format keys.【F:tests/unit/test_translation_placeholders.py†L1-L66】【F:custom_components/pawcontrol/strings.json†L1-L640】【F:custom_components/pawcontrol/translations/en.json†L1-L640】
- Repairs now publish aggregated cache health issues and the unit suite exercises both creation and clear-down flows to keep anomaly reporting reliable.【F:custom_components/pawcontrol/repairs.py†L200-L260】【F:tests/test_repairs.py†L560-L680】
- Coordinator update/runtime statistics now embed condensed repairs telemetry so dashboards and system health endpoints expose severity counters alongside cache metrics, backed by new unit coverage for the coordinator tasks helper.【F:custom_components/pawcontrol/coordinator_support.py†L68-L129】【F:custom_components/pawcontrol/coordinator_tasks.py†L22-L90】【F:tests/unit/test_coordinator_tasks.py†L65-L106】
- Diagnostics exports now surface cache monitor snapshots with redacted payloads so Platinum observability tooling can analyse nightly telemetry via Home Assistant’s diagnostics panel.【F:custom_components/pawcontrol/diagnostics.py†L100-L360】【F:tests/components/pawcontrol/test_diagnostics.py†L1-L220】
- Storage namespaces and helper manager caches now auto-register with the data manager monitor, exposing sanitized per-dog diagnostics alongside regression coverage for namespace updates and helper telemetry capture. Runtime cache registration now replays helper monitors after `store_runtime_data` so reloads retain diagnostics coverage.【F:custom_components/pawcontrol/data_manager.py†L1030-L1310】【F:custom_components/pawcontrol/helper_manager.py†L40-L240】【F:tests/unit/test_data_manager.py†L200-L360】
- Script and door-sensor managers now publish cache diagnostics through the shared registrar, and storage namespace monitors flag timestamp anomalies for repairs with dedicated unit coverage guarding the new heuristics.【F:custom_components/pawcontrol/script_manager.py†L20-L220】【F:custom_components/pawcontrol/door_sensor_manager.py†L160-L360】【F:custom_components/pawcontrol/data_manager.py†L440-L560】【F:tests/unit/test_data_manager.py†L280-L520】
