# Development Plan

## Quality Gate Expectations
- Run `ruff check`, `pytest`, `mypy`, and `python -m script.hassfest --integration-path custom_components/pawcontrol` before every pull request to match the repository guardrails.【F:.github/copilot-instructions.md†L10-L28】【F:.github/copilot-instructions.md†L52-L70】
- Target Python 3.13+ typing throughout the integration; keep new helpers within the existing Platinum-quality architecture under `custom_components/pawcontrol`.【F:pyproject.toml†L37-L72】【F:custom_components/pawcontrol/__init__.py†L1-L213】

## Current Failure Backlog
- **Diagnostics front-end alignment:** Coordinator snapshots, runtime statistics, and diagnostics seed a default `rejection_metrics` payload with `schema_version`, and the Platinum dashboard now renders the block directly—documentation has been refreshed with the validated JSON extract so future UI drops can be spot-checked without scraping.【F:custom_components/pawcontrol/coordinator_observability.py†L40-L154】【F:custom_components/pawcontrol/coordinator_tasks.py†L672-L829】【F:custom_components/pawcontrol/diagnostics.py†L598-L666】【F:tests/unit/test_coordinator_observability.py†L1-L190】【F:tests/unit/test_coordinator_tasks.py†L200-L970】【F:docs/diagnostik.md†L64-L90】
- **Config flow harness stabilisation:** Repeated stub installs now short-circuit after the first load, keeping the compatibility `ConfigFlow` alias bound to the active Home Assistant base classes without invalidating previously imported exception types. Compat exports broadcast rebind events to the flow, validation helpers, and entity/service layers so previously imported proxies (including `_ConfigEntryNotReady` and `ServiceValidationError`) are refreshed in place, the binder still infers caller modules automatically, and each callback now resolves the live module straight from `sys.modules` so reloads no longer require weak-reference bookkeeping. Follow-ups can concentrate on reconfigure/update logic instead of alias lookup failures.【cc5f8a†L1-L9】【9f224b†L1-L49】【F:custom_components/pawcontrol/compat.py†L101-L212】【F:tests/components/pawcontrol/conftest.py†L1-L36】【F:tests/integration/conftest.py†L1-L36】【F:tests/helpers/homeassistant_test_stubs.py†L1852-L1875】【F:tests/components/pawcontrol/test_config_flow.py†L40-L112】【F:tests/components/pawcontrol/test_config_flow.py†L600-L616】
- **Resilience telemetry follow-up:** The circuit breaker now surfaces open/half-open rejections via the dedicated `CircuitBreakerStateError`, increments `rejected_calls`, and logs the state transition instead of raising the proxy error. Coordinator diagnostics, performance snapshots, and runtime service telemetry persist the rejection counters, last rejection timestamps, and breaker identifiers in step with the new schema; front-end validation remains pending once the updated dashboard lands in Platinum builds.【783108†L117-L150】【F:custom_components/pawcontrol/resilience.py†L200-L312】【F:custom_components/pawcontrol/coordinator_tasks.py†L672-L829】【F:custom_components/pawcontrol/coordinator_observability.py†L40-L154】【F:custom_components/pawcontrol/services.py†L320-L420】【F:tests/unit/test_coordinator_tasks.py†L200-L940】【F:tests/unit/test_coordinator_observability.py†L1-L138】
- **Notification quiet hours fixture:** Tests patch `dt.utcnow` with timezone-aware datetimes so the Home Assistant time helpers behave under Python 3.13. Keep auditing notification call sites for lingering `dt.now` usages before enabling broader time-based automation coverage.【783108†L150-L158】【F:tests/unit/test_notifications.py†L371-L404】
- **Garden service validation propagation:** `_service_validation_error` now honours compat overrides while preferring the active `homeassistant.exceptions.ServiceValidationError`, ensuring garden handlers raise the live Home Assistant validation class across stub reloads and monkeypatched tests. Extend telemetry assertions to capture validation payloads in diagnostics once the performance sweep is finished.【783108†L158-L190】【F:custom_components/pawcontrol/services.py†L90-L127】【F:tests/components/pawcontrol/test_services.py†L190-L235】【F:tests/unit/test_services.py†L1-L38】
- **Type-checking debt:** A fresh `mypy custom_components/pawcontrol` run reports 390 errors across 45 files, touching compatibility shims, coordinators, entity factories, and config flows. The dog management mixin now coerces GPS and health inputs through typed helpers, normalises cached validation payloads, and surfaces medication/vaccination data with literal keys, while the helper manager rebuild merges via `DogModulesConfig`/`ModuleToggleKey` so module toggles stay statically typed. Follow-up sweeps should focus on the remaining base/mixin literals and high-churn managers before re-enabling strict typing globally.【6df02e†L1-L5】【F:custom_components/pawcontrol/config_flow_dogs.py†L200-L760】【F:custom_components/pawcontrol/helper_manager.py†L1-L360】【F:custom_components/pawcontrol/types.py†L360-L520】

## Regression Coverage and Opportunities
- Feeding compliance aggregation now ships additional regression coverage that exercises nested, recursive, and parallel iteration so `_normalise_sequence` snapshots remain reusable without over-consuming structured telemetry sources.【F:custom_components/pawcontrol/feeding_translations.py†L320-L369】【F:tests/unit/test_feeding_translations.py†L1-L160】
- Preserve the expanded `_format_structured_message` scenarios as guardrails while iterating on notification payload sanitisation; the tests already cover recursive mappings and mixed iterables, so future refactors should extend, not replace, these fixtures.【F:custom_components/pawcontrol/feeding_translations.py†L327-L350】【F:tests/unit/test_feeding_translations.py†L98-L160】
- Config flow harness stability is now protected by regression tests that assert the exported `ConfigFlow` alias continues to reference `PawControlConfigFlow`, that compat broadcasts refreshes across modules, that validation/service helpers emit the rebound Home Assistant exceptions when stubs change mid-run, that dynamic module imports trigger the automatic `bind_exception_alias` inference without explicit module handles—even when the binding is triggered from helper functions or via an explicit module name hint—and that bindings persist after module reloads so fixtures can hot-swap Home Assistant stubs mid-test.【F:tests/components/pawcontrol/test_config_flow.py†L43-L108】【F:tests/unit/test_exception_alias_rebinds.py†L1-L184】【F:custom_components/pawcontrol/compat.py†L93-L218】

## Near-term Focus
1. Monitor the Platinum diagnostics panel for future UI schema bumps and keep the docs snippet aligned with the live `rejection_metrics` payload so dashboards stay audit-ready.【F:docs/diagnostik.md†L64-L90】【F:docs/portal/traceability_matrix.md†L1-L80】
2. Continue chipping away at the typing backlog—next targets are the remaining config flow mixins and helper factories (module toggles, feeding schedulers) so the mypy error count falls ahead of reenabling strict gates.【db3742†L1-L126】【F:custom_components/pawcontrol/config_flow_dogs.py†L200-L760】【F:custom_components/pawcontrol/helper_manager.py†L200-L560】
3. Keep `.github/copilot-instructions.md`, `.claude/agents/copilot-instructions.md`, and `.gemini/styleguide.md` aligned whenever requirements change so assistant guidance stays consistent.【F:.github/copilot-instructions.md†L1-L110】【F:.claude/agents/copilot-instructions.md†L1-L120】【F:.gemini/styleguide.md†L1-L200】

## Tooling Checklist
- `ruff check`
- `pytest tests/unit/test_coordinator_observability.py -q`
- `pytest tests/unit/test_coordinator_tasks.py::test_build_update_statistics_defaults_rejection_metrics -q`
- `pytest tests/unit/test_feeding_translations.py -q`
- `pytest tests/unit/test_services.py::test_check_feeding_compliance_sanitises_structured_messages -q`
- `pytest tests/unit/test_services.py::test_service_validation_error_uses_compat_alias -q`
- `pytest tests/test_repairs.py::test_async_publish_feeding_compliance_issue_sanitises_mapping_message -q`
- `python -m script.hassfest --integration-path custom_components/pawcontrol`

Record outcomes for each run in commit discussions so we maintain an auditable trail before broadening the Platinum gates.【F:.github/copilot-instructions.md†L10-L28】
