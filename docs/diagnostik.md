# PawControl Diagnosebericht (Stand Integration `work`)

## Zusammenfassung

- Die aktuelle Integration liefert den in den Handbüchern beschriebenen Umfang für Garden-Tracking, Diet-Validierung, Health-Emergencies sowie GPS-/Geofencing-Workflows. Sämtliche zugesagten Entitäten existieren inklusive Übersetzungen und greifen auf Managerdaten aus dem Koordinator zu.
- Die Service-Schicht ist vollständig registriert, nutzt flächendeckend `ServiceValidationError` für Payload-Prüfungen und stellt auch die zuvor fehlenden GPS- und Garden-Services bereit.
- Diagnostics, Options-Flow und Manager-Struktur sind auf die erweiterten Module abgestimmt, sodass Support-Daten, Konfigurationspfade und Automations-Hooks den Dokumentationen entsprechen.

## Funktionsabgleich

### Garden-Tracking
- Sensorplattform: `sensor.py` enthält ein eigenes Garden-Modul mit zwölf spezialisierten Sensoren (u. a. `garden_time_today`, `last_garden_session`, `garden_activities_last_session`) auf Basis von `PawControlGardenSensorBase`, die über den Koordinator auf Snapshots des `GardenManager` zugreifen.【F:custom_components/pawcontrol/sensor.py†L1295-L1610】
- Binary-Sensoren: `binary_sensor.py` liefert `garden_session_active`, `in_garden` und `garden_poop_pending`, jeweils mit Manager-Fallback und Attributen für Pending-Confirmations.【F:custom_components/pawcontrol/binary_sensor.py†L1583-L1657】
- Buttons und Services: Die Tests decken Start/Stop/Pending-Flows ab; Garden-Daten werden im gemeinsamen Koordinator-Fixture bereitgestellt.【F:tests/components/pawcontrol/test_all_platforms.py†L69-L219】

### Health & Diet
- Health-Notfälle: `PawControlHealthEmergencyBinarySensor` stellt die dokumentierten Attribute (`emergency_type`, `portion_adjustment`, `activated_at`, `expires_at`, `status`) bereit und konsumiert Managerdaten.【F:custom_components/pawcontrol/binary_sensor.py†L1571-L1579】
- Diet-Validation: Separate Sensoren für Konflikte, Warnungen, Vet-Empfehlung, Anpassungsfaktor und Kompatibilitätsscore sind implementiert und lesen die `diet_validation_summary` aus dem Feeding-Modul.【F:custom_components/pawcontrol/sensor.py†L1952-L2179】【F:tests/components/pawcontrol/test_all_platforms.py†L91-L124】

### Services & Validierung
- Service-Infrastruktur: `services.py` registriert alle Feeding-, Walk-, Garden-, GPS-, Notification- und Helper-Services inklusive der vormals fehlenden GPS-Routenfunktionen (`gps_start_walk`, `gps_end_walk`, `gps_post_location`, `gps_export_route`, `setup_automatic_gps`).【F:custom_components/pawcontrol/services.py†L967-L1140】
- Eingabevalidierung: `_resolve_dog` und weitere Handler werfen bei fehlerhaften Parametern gezielt `ServiceValidationError`, womit die Qualitätsrichtlinie erfüllt ist.【F:custom_components/pawcontrol/services.py†L614-L688】

### GPS & Geofencing
- Manager: `PawControlGeofencing` implementiert Zone-Management, Persistenz, Background-Loops und Ereignisverarbeitung; die Initialisierung erzeugt automatisch eine Home-Zone und startet Monitoring-Tasks.【F:custom_components/pawcontrol/geofencing.py†L207-L360】
- Integrationseinbindung: Während des Setups wird der Geofencing-Manager erstellt, sobald GPS-Module aktiv sind; Koordinator und weitere Manager werden parallel initialisiert.【F:custom_components/pawcontrol/__init__.py†L320-L400】
- Service- und Optionspfad: Die GPS-Services verknüpfen Geofencing- und Notifications-Manager, und der Options-Flow stellt entsprechende Selektoren für Tracker, Personen und Safe-Zonen zur Verfügung.【F:custom_components/pawcontrol/services.py†L967-L1140】【F:custom_components/pawcontrol/config_flow_external.py†L80-L137】

### Diagnostics & QA
- Diagnostics-Modul exportiert Konfiguration, Laufzeitdaten, Performance-Metriken und redigierte Schlüssel, womit Support-Daten den Guides entsprechen.【F:custom_components/pawcontrol/diagnostics.py†L1-L187】
- Die Koordinator-Snapshots liefern ein stets vorhandenes `rejection_metrics`-Objekt mit `schema_version`, Ablehnungszählern, Breaker-Listen (einschließlich `unknown_breaker_ids`) und dem Zeitstempel der letzten Ablehnung; Update- und Runtime-Statistiken kopieren inzwischen dieselben Zähler *und* die ID- beziehungsweise Namenlisten (`open_breakers`/`open_breaker_ids`, `half_open_breakers`/`half_open_breaker_ids`, `unknown_breakers`/`unknown_breaker_ids`, `rejection_breakers`/`rejection_breaker_ids`) in `performance_metrics` sowie `error_summary`, sodass Platinum-Dashboards, die kommende UI-Aktualisierung und die Dokumentationen ohne Scraping auf alle Resilience-Felder zugreifen können.【F:custom_components/pawcontrol/coordinator_observability.py†L96-L137】【F:custom_components/pawcontrol/coordinator_tasks.py†L804-L956】【F:custom_components/pawcontrol/diagnostics.py†L120-L180】【F:tests/unit/test_coordinator_observability.py†L64-L212】【F:tests/unit/test_coordinator_tasks.py†L200-L1108】
- Service-Guards erfassen jeden Home-Assistant-Serviceaufruf in `ServiceGuardResult`-Snapshots, aggregieren Ausführungen und Übersprünge zu `ServiceGuardSummary`-Metriken und persistieren diese über `_record_service_result`, sodass Diagnostics und Resilience-Berichte anzeigen, wann Guards stattgefunden haben; der Export erfolgt jetzt gebündelt unter `service_execution.guard_metrics` samt letztem Eintrag in `service_execution.last_service_result` für den direkten Support-Zugriff.【F:custom_components/pawcontrol/service_guard.py†L1-L46】【F:custom_components/pawcontrol/utils.py†L187-L264】【F:custom_components/pawcontrol/services.py†L414-L569】【F:custom_components/pawcontrol/diagnostics.py†L1004-L1062】【F:tests/components/pawcontrol/test_diagnostics.py†L294-L353】
- Service-Diagnostics enthalten zusätzlich `rejection_metrics`: `_record_service_result` synchronisiert den gespeicherten Resilience-Snapshot über `merge_rejection_metric_values`, legt ihn unter `performance_stats.rejection_metrics` ab und exportiert denselben Block für Support-Tools. Regressionen belegen sowohl vollständige Breaker-Listen als auch Circuit-Recovery-Szenarien ohne aktive Breaker, damit Diagnostik- und Dashboard-Auswertungen stets auf einen konsistenten Standard-Snapshot zugreifen.【F:custom_components/pawcontrol/services.py†L414-L569】【F:custom_components/pawcontrol/diagnostics.py†L1004-L1062】【F:tests/unit/test_services.py†L120-L204】
- Boolesche Normalisierungen protokollieren ab sofort unerwartete Payloads und Defaults als `bool_coercion`-Telemetrie: `_coerce_bool` meldet `none`-, `blank_string`- und `fallback`-Konvertierungen an `record_bool_coercion_event`, ergänzt jetzt aber auch native Wahrheitswerte (`native_true`/`native_false`), `numeric_nonzero`/`numeric_zero` sowie `truthy_string`/`falsy_string`/`unknown_string`, damit Diagnose-Zähler erkannte und unbekannte Eingaben getrennt erfassen; Diagnostics exportiert die Aggregation samt Beispieleinträgen, `reset_count`, einem ISO-Zeitstempel `last_reset`, `first_seen`-/`last_seen`-Zeitstempeln, dem daraus berechneten `active_window_seconds`, dem neuesten `last_reason`, dem zuletzt normalisierten Wert inklusive Typ und Repräsentation (`last_value_type`/`last_value_repr`) sowie dem letzten Ergebnis und Default (`last_result`/`last_default`), und neue Regressionstests sichern die erweiterten Gründe für Legacy-Optionen sowie den Nullzustand der Diagnostics; darüber hinaus spiegelt `build_performance_snapshot` die kondensierte Bool-Telemetrie via `summarise_bool_coercion_metrics`, sodass Koordinator-Leistungs-Snapshots Reset-Zähler, Gründe und begrenzte Beispielwerte für Dashboards bereitstellen, die Diagnostics ergänzen zusätzlich den kompakten `summary`-Block, damit Support-Werkzeuge auf denselben Trimmed-Snapshot zugreifen können wie die Koordinator-Ansichten, `build_runtime_statistics` persistiert die komprimierte Zusammenfassung jetzt unter `bool_coercion`, bevor sie im Runtime-Cache abgelegt wird, und die Diagnostik-Aggregation ruft `update_runtime_bool_coercion_summary` auf, sodass sowohl wiederverwendete Performance-Statistiken als auch Diagnostik-Aufrufe denselben gespeicherten Snapshot ausgeben.【F:custom_components/pawcontrol/types.py†L409-L466】【F:custom_components/pawcontrol/telemetry.py†L29-L420】【F:custom_components/pawcontrol/coordinator_observability.py†L58-L122】【F:custom_components/pawcontrol/coordinator_tasks.py†L905-L933】【F:custom_components/pawcontrol/diagnostics.py†L1033-L1062】【F:tests/unit/test_bool_coercion_telemetry.py†L18-L350】【F:tests/unit/test_coordinator_observability.py†L49-L210】【F:tests/unit/test_coordinator_tasks.py†L1003-L1034】【F:tests/coverage/coverage_coordinator_observability.py†L223-L251】【F:tests/components/pawcontrol/test_diagnostics.py†L294-L357】
- Die Notification-Diagnostics erfassen neu die Hintergrund-Retry-Telemetrie über `retry_reschedules` und `retry_successes`, sodass Support-Teams nachvollziehen können, wann mobile Auslieferungen erneut geplant und schließlich erfolgreich zugestellt wurden; die Regressionstests decken den Ablauf von gescheiterten Erstversuchen bis zur erfolgreichen Wiederholung mit aktualisierten Leistungskennzahlen ab.【F:custom_components/pawcontrol/notifications.py†L487-L512】【F:custom_components/pawcontrol/notifications.py†L1940-L1977】【F:tests/unit/test_notifications.py†L1100-L1165】【F:tests/unit/test_notifications.py†L1186-L1325】
- Reconfigure-Telemetrie und Form-Placeholders führen `merge_notes` ein, um zusammenzufassen, welche Optionen- oder `dog_options`-Snapshots während der Migration übernommen wurden; Diagnostics- und Options-Flow-Exports enthalten dieselbe Liste, wodurch Support-Teams schnell erkennen, wann Konfigurationsdaten wegen Legacy-Formaten normalisiert wurden.【F:custom_components/pawcontrol/config_flow.py†L2321-L2684】【F:custom_components/pawcontrol/telemetry.py†L46-L83】【F:tests/components/pawcontrol/test_config_flow.py†L471-L640】【F:tests/unit/test_options_flow.py†L389-L430】【F:tests/unit/test_services.py†L720-L810】
- Der Dashboard-Konfigurationsschritt übersetzt die Platzhalter `dashboard_info` und `features` über `translated_dashboard_setup`, `translated_dashboard_feature` sowie die neuen Info-Zeilen im Dashboard-Mixin, sodass deutschsprachige Installationen unmittelbar „Das Dashboard enthält …“ und lokalisierte Feature-Listen sehen; die Config-Flow-Regression `test_configure_dashboard_form_localizes_placeholders` prüft die Ausgabe.【F:custom_components/pawcontrol/config_flow_modules.py†L90-L659】【F:custom_components/pawcontrol/config_flow_dashboard_extension.py†L46-L236】【F:tests/components/pawcontrol/test_config_flow.py†L1592-L1674】
- Sequenzfelder innerhalb der Reconfigure-Migrationen werden additiv zusammengeführt, leere Überschreibungen gelten als „keine Änderung“, und das Direktive `__pc_merge_remove__` leert Listen gezielt, wodurch Diagnostik-Snapshots deterministische Hundepayloads für Support-Analysen liefern.【F:custom_components/pawcontrol/config_flow.py†L2534-L2632】【F:tests/components/pawcontrol/test_config_flow.py†L804-L906】
- Die Dashboard-Generatoren injizieren die `CoordinatorStatisticsPayload`-Snapshots des Koordinators in die Statistik-Ansicht, wodurch die Markdown-Zusammenfassung jetzt automatisch die Ablehnungszähler, Breaker-Anzahl, den Zeitstempel der letzten Ablehnung *und* die offenen, halb geöffneten, unbekannten sowie blockierenden Breaker-ID-Listen darstellt.【F:custom_components/pawcontrol/dashboard_generator.py†L120-L214】【F:custom_components/pawcontrol/dashboard_renderer.py†L148-L260】【F:custom_components/pawcontrol/dashboard_templates.py†L1404-L1538】【F:tests/unit/test_dashboard_templates.py†L473-L533】【F:tests/unit/test_dashboard_generator.py†L210-L272】
- Die neuen Breaker-Namenslisten verwenden lokalisierte Labels (z. B. „Namen offener Breaker“, „IDs blockierender Breaker“) und geben leere Listen jetzt sprachabhängig als „none“/„keine“ aus, sodass deutsch- und englischsprachige Dashboards dieselben Begriffe wie die Diagnose-Guides verwenden und Snapshot-Tests die Übersetzungen samt Leerlisten absichern.【F:custom_components/pawcontrol/dashboard_templates.py†L1404-L1555】【F:tests/unit/test_dashboard_templates.py†L473-L620】
- Die Resilience-Zusammenfassung übersetzt zusätzlich die Fallback-Werte für Ablehnungsrate und Zeitpunkt, sodass „n/a“/„never“ bei inaktiven Breakern automatisch als „nicht verfügbar“ beziehungsweise „nie“ erscheinen und die Kartenzeile zum letzten Breaker entfällt, wenn keine Kennung vorliegt; zugleich lokalisieren Markdown-Header und Zählerbeschriftungen („Rejected calls“, „Rejecting breakers“, „Rejection rate“, „Last rejection“) die aktive Home-Assistant-Sprache, wodurch deutschsprachige Dashboards keine englischen Resttexte mehr anzeigen. Regressionstests prüfen beide Sprachvarianten.【F:custom_components/pawcontrol/dashboard_templates.py†L1519-L1592】【F:tests/unit/test_dashboard_templates.py†L545-L686】
- Die Statistik-Zusammenfassung übersetzt jetzt auch Kopfzeile, Hundezähler, Modulüberschrift, Modulnamen sowie den Kartentitel anhand der aktiven Home-Assistant-Sprache, wodurch deutschsprachige Dashboards ohne zusätzliche Anpassungen dieselben Begriffe wie die Dokumentation anzeigen. Neue Regressionstests prüfen die deutsche Ausgabe der Kopfzeile, Module und des Titels.【F:custom_components/pawcontrol/dashboard_templates.py†L1462-L1646】【F:tests/unit/test_dashboard_templates.py†L105-L151】
- Die Benachrichtigungs-Dashboards lokalisieren Kartenüberschrift, Kennzahlen, Aktionsbuttons sowie Platzhaltertexte anhand der Home-Assistant-Sprache und versenden Testbenachrichtigungen mit übersetzten Titeln und Nachrichten. Die Regressionstests prüfen deutschsprachige Überschriften, Zähler, Buttontexte und die Fallback-Nachricht ohne Verlauf.【F:custom_components/pawcontrol/dashboard_templates.py†L1732-L1835】【F:tests/unit/test_dashboard_templates.py†L760-L844】
- Die Fütterungsübersicht setzt Kartentitel und Meal-Buttons sprachabhängig, sodass moderne und minimale Layouts sofort „Fütterungsplan“, „Frühstück“, „Mittagessen“, „Abendessen“ und „Snack“ anzeigen. Neue Tests sichern die deutschen Titel und Buttonbeschriftungen ab.【F:custom_components/pawcontrol/dashboard_templates.py†L1837-L1915】【F:tests/unit/test_dashboard_templates.py†L846-L870】
- Die Besuchermodus-Karten lokalisieren Entities-Titel, Statusüberschrift, Feldbezeichnungen sowie Ja/Nein- und Fallback-Werte, damit deutschsprachige Dashboards dieselben Formulierungen nutzen; Regressionstests prüfen die übersetzten Titel und Platzhalter.【F:custom_components/pawcontrol/dashboard_cards.py†L89-L176】【F:custom_components/pawcontrol/dashboard_cards.py†L1694-L1769】【F:tests/unit/test_dashboard_templates.py†L979-L1088】
- Die Spaziergang-Dashboards lokalisieren Statuskarten, Schnellaktionen, Steuerungsbuttons, Wetter-Zeitkarten sowie Statistik-Titel anhand der aktiven Sprache, sodass deutschsprachige Oberflächen ohne Rest-Englisch auskommen; Regressionstests sichern die deutschen Walk-Karten und Quick-Action-Texte.【F:custom_components/pawcontrol/dashboard_cards.py†L121-L220】【F:custom_components/pawcontrol/dashboard_cards.py†L651-L741】【F:custom_components/pawcontrol/dashboard_cards.py†L1487-L1594】【F:custom_components/pawcontrol/dashboard_cards.py†L2784-L2808】【F:tests/unit/test_dashboard_templates.py†L960-L1044】
- Die globalen Quick-Action-Buttons übersetzen jetzt auch „Alle füttern“ und „Täglicher Reset“ über `_translated_quick_action_label`, womit Sammelaktionen in der jeweiligen Home-Assistant-Sprache erscheinen; eine neue Regression prüft die deutschen Buttons inklusive des bestehenden Spazierstatus-Labels.【F:custom_components/pawcontrol/dashboard_cards.py†L89-L362】【F:custom_components/pawcontrol/dashboard_cards.py†L776-L862】【F:tests/unit/test_dashboard_templates.py†L1008-L1052】
- Die Gesundheits- und Gewichtsdashboards übersetzen Status- und Portionskarten, Gewichtshistorien, Gesundheitspläne sowie die Wettergesundheitstitel über `_translated_health_label` und `_translated_health_template`; neue Regressionstests prüfen die deutschen Health- und Wetterkarten samt Diagrammen.【F:custom_components/pawcontrol/dashboard_cards.py†L1105-L1407】【F:custom_components/pawcontrol/dashboard_templates.py†L120-L360】【F:tests/unit/test_dashboard_templates.py†L1189-L1287】
- Die Grooming-Workflows übersetzen Start-Buttons, Helper-Namen und Service-Benachrichtigungen über `translated_grooming_label` beziehungsweise `translated_grooming_template`; ein neuer Servicetest prüft den deutschen Titel und Nachrichtentext der Startbenachrichtigung.【F:custom_components/pawcontrol/button.py†L1631-L1668】【F:custom_components/pawcontrol/helper_manager.py†L569-L586】【F:custom_components/pawcontrol/services.py†L3649-L3706】【F:tests/unit/test_services.py†L2188-L2232】
- Grooming-Modulschalter, Feature-Toggles sowie die Modulbeschreibung im Options-Flow nutzen dieselben Übersetzungs-Helper, sodass deutschsprachige Setups „Pflege-Tracking“, „Pflegeplan“ und „Pflege-Erinnerungen“ anzeigen; Switch- und Options-Flow-Tests sichern die lokalisierten Namen und Zusammenfassungen ab.【F:custom_components/pawcontrol/switch.py†L626-L688】【F:custom_components/pawcontrol/options_flow.py†L2602-L2630】【F:tests/components/pawcontrol/test_all_platforms.py†L1003-L1034】【F:tests/unit/test_options_flow.py†L1239-L1253】
- Der letzte Pflege-Termin (`PawControlLastGroomingDateTime`) protokolliert manuelle Einträge jetzt ebenfalls sprachabhängig, damit deutsche Installationen benutzerfreundliche Notizen erhalten; `test_last_grooming_datetime_localizes_notes` prüft den übersetzten Text.【F:custom_components/pawcontrol/datetime.py†L432-L470】【F:tests/unit/test_datetime_entities.py†L1-L35】
- Das Platinum-Diagnostics-Panel in der aktuellen UI-Build zeigt den neuen Block mit `schema_version: 3` unmittelbar unter den Performance-Karten an; der JSON-Ausschnitt unten stammt aus dem validierten Front-End-Snapshot und bestätigt, dass Dashboard, Backend und Dokumentation dieselbe Struktur nutzen.【F:custom_components/pawcontrol/coordinator_observability.py†L96-L154】【F:tests/unit/test_coordinator_observability.py†L88-L124】

### Leistungseinstellungen
- Die Leistungsmodi `minimal`, `balanced` und `full` werden zentral über `normalize_performance_mode` gepflegt; damit bleiben Optionen, Select-Plattform und gespeicherte Snapshots synchron, während das frühere Alias `standard` automatisch auf `balanced` normalisiert wird.【F:custom_components/pawcontrol/types.py†L456-L509】【F:custom_components/pawcontrol/select.py†L763-L806】
- Regressionstests sichern die Alias-Behandlung und stellen sicher, dass vorhandene Installationen nach dem Upgrade weiterhin mit dem kanonischen `balanced`-Standard starten, ohne dass Benutzer die Optionen manuell anpassen müssen.【F:tests/unit/test_types_performance_mode.py†L1-L35】

```json
{
  "rejection_metrics": {
    "schema_version": 3,
    "rejected_call_count": 0,
    "rejection_breaker_count": 0,
    "rejection_rate": 0.0,
    "last_rejection_time": null,
    "last_rejection_breaker_id": null,
    "last_rejection_breaker_name": null,
    "open_breaker_count": 0,
  "half_open_breaker_count": 0,
  "unknown_breaker_count": 0,
  "open_breaker_ids": [],
  "half_open_breaker_ids": [],
  "unknown_breaker_ids": [],
  "open_breakers": [],
  "half_open_breakers": [],
  "unknown_breakers": [],
  "rejection_breaker_ids": [],
  "rejection_breakers": []
}
}
```
- Tests: `tests/components/pawcontrol/test_all_platforms.py` liefert eine umfassende Fixture mit Garden-, Diet- und Emergency-Daten für Sensor-, Binary-Sensor-, Button- und Servicepfade.【F:tests/components/pawcontrol/test_all_platforms.py†L1-L219】
- Cache-Reparatur-Telemetrie wird vor dem Export über `ensure_cache_repair_aggregate` in das `CacheRepairAggregate`-Dataclass-Format überführt, sodass Performance-, Services-, Koordinator- **und Diagnostik**-Pfad ausschließlich typisierte Payloads serialisieren und Reloads keinen Mapping-Fallback mehr zulassen.【F:custom_components/pawcontrol/coordinator_support.py†L132-L147】【F:custom_components/pawcontrol/performance.py†L149-L158】【F:custom_components/pawcontrol/services.py†L360-L363】【F:custom_components/pawcontrol/diagnostics.py†L300-L359】

## Verbleibende Beobachtungen

- Einige historische Konfigurationskonstanten wie `CONF_SOURCES`, `CONF_PERSON_ENTITIES`, `CONF_DEVICE_TRACKERS`, `CONF_CALENDAR` oder `CONF_WEATHER` sind weiterhin ausschließlich in `const.py` definiert und besitzen keine weiteren Verwendungen im aktiven Codepfad, obwohl ergänzende Features (z. B. externe Kalender-Hooks) in älteren Dokumenten erwähnt werden.【F:custom_components/pawcontrol/const.py†L101-L119】【904f82†L1-L6】
- Das Performance-Monitoring-Set (`CORE_SERVICES`, `PERFORMANCE_THRESHOLDS`) bleibt bislang unreferenziert; eine spätere Integration in Telemetrie- oder Diagnostics-Routinen ist möglich, derzeit existiert jedoch keine Auswertung.【F:custom_components/pawcontrol/const.py†L347-L356】【11fb2d†L1-L6】
- Dashboard-/Automation-Templates decken den dokumentierten Funktionsumfang bereits ab; zusätzliche End-to-End-Tests für GPS-/Geofencing-Flows können künftig Regressionen reduzieren.
