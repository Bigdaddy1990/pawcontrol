# .github/workflows/ruff-baseline.yml
name: Ruff baseline (web only)
on: { workflow_dispatch: {} }
permissions: { actions: read, contents: write, pull-requests: write, statuses: read}
env:
  PYTHON_VERSION: ${{ vars.PYTHON_VERSION != '' && vars.PYTHON_VERSION || '3.14' }}
jobs:
  baseline:
    if: >-
      ${{
        github.event_name == 'workflow_dispatch' && (
          (vars.RUFF_BASELINE_ALLOWLIST == '' && github.actor == github.repository_owner) ||
          (vars.RUFF_BASELINE_ALLOWLIST != '' && contains(format(',{0},', vars.RUFF_BASELINE_ALLOWLIST), format(',{0},', github.actor)))
        )
      }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: python -m pip install --upgrade pip ruff

      - name: Initial baseline check
        id: baseline_check
        continue-on-error: true
        run: ruff check . --output-format=github

      - name: Apply baseline fixes when needed
        if: steps.baseline_check.outcome == 'failure'
        run: |
          ruff check . --fix
          ruff check . --fix --unsafe-fixes
          ruff check . --add-noqa
          ruff check . --extend-select RUF100 --fix
          ruff format

      - name: Re-run baseline check
        if: steps.baseline_check.outcome == 'failure'
        run: ruff check . --output-format=github

      - name: Skip PR when baseline already clean
        id: skip_pr
        run: |
          if git diff --quiet; then
            echo "create_pr=false" >> "$GITHUB_OUTPUT"
          else
            echo "create_pr=true" >> "$GITHUB_OUTPUT"
          fi

      - uses: peter-evans/create-pull-request@v8
        if: steps.skip_pr.outputs.create_pr == 'true'
        with:
          branch: chore/ruff-baseline
          title: "chore: ruff baseline (format+fix+noqa)"
          commit-message: "chore: ruff baseline (format+fix+noqa)"
          body: "Automated ruff baseline via GitHub Actions."
