name: Monitor vendored PyYAML

on:
  schedule:
    # Run every Wednesday at 02:30 UTC to validate PyYAML releases after the
    # upstream Tuesday release cadence.
    - cron: "30 2 * * 3"
  workflow_dispatch:
    inputs:
      fail_on_outdated:
        description: "Fail the run when PyPI ships a newer stable release?"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  pull-requests: write

env:
  PYTHON_VERSION: ${{ vars.PYTHON_VERSION != '' && vars.PYTHON_VERSION || '3.13' }}

jobs:
  vendor-check:
    name: Check vendored PyYAML status
    runs-on: ubuntu-latest
    env:
      FAIL_ON_OUTDATED: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.fail_on_outdated || 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Evaluate vendored PyYAML drift
        run: |
          set -euo pipefail
          if [ "${FAIL_ON_OUTDATED}" = 'true' ]; then
            python -m scripts.check_vendor_pyyaml --fail-on-outdated
          else
            python -m scripts.check_vendor_pyyaml
          fi
