name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: ${{ vars.PYTHON_VERSION != '' && vars.PYTHON_VERSION || '3.13' }}
  HA_VERSION: ${{ vars.HA_VERSION != '' && vars.HA_VERSION || '2026.1.1' }}
  CI_COVERAGE_MIN: ${{ vars.CI_COVERAGE_MIN != '' && vars.CI_COVERAGE_MIN || '95' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


jobs:
  ruff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/ruff-action@v3

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements.txt

      - name: Install Ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Ruff check
        run: |
          ruff check custom_components/pawcontrol --output-format=github
          ruff format custom_components/pawcontrol --check

      - name: CodeFactor Analysis
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "CodeFactor analysis runs automatically via webhook"
          echo "Visit: https://www.codefactor.io/repository/github/${{ github.repository }}"
      
  lint:
    name: Lint
    uses: ./.github/workflows/reusable-pre-commit.yml
    with:
      python-version: ${{ vars.PYTHON_VERSION }}
    secrets: inherit

  typed-dict-audit:
    name: TypedDict audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements.txt
            requirements_test.txt

      - name: Install repository requirements
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install -r requirements_test.txt

      - name: Run TypedDict guard
        run: |
          python -m script.check_typed_dicts \
            --path custom_components/pawcontrol \
            --path tests \
            --fail-on-findings

      - name: Publish TypedDict audit summary
        if: success()
        run: |
          {
            echo "### âœ… TypedDict audit"
            echo
            echo "- Python: ${{ env.PYTHON_VERSION }}"
            echo "- Paths: \`custom_components/pawcontrol\`, \`tests\`"
            echo "- Command: \`python -m script.check_typed_dicts --path custom_components/pawcontrol --path tests --fail-on-findings\`"
          } >> "$GITHUB_STEP_SUMMARY"

  test-coverage:
    name: Test & Coverage
    uses: ./.github/workflows/reusable-python-tests.yml
    with:
      python-version: ${{ vars.PYTHON_VERSION }}
      home-assistant-spec: ${{ format('=={0}', vars.HA_VERSION) }}
      coverage-min: ${{ vars.CI_COVERAGE_MIN }}
      coverage-xml-path: generated/coverage/coverage.xml
      coverage-html-dir: generated/coverage/html
      upload-junit-artifact: true
      junit-artifact-name: junit-results
    secrets: inherit

  coverage-comment:
    name: Coverage Summary Comment
    needs: test-coverage
    if: ${{ github.event_name == 'pull_request' && needs.test-coverage.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Prepare coverage summary
        id: summary
        env:
          COVERAGE_PERCENT: ${{ vars.CI_COVERAGE_MIN }}
          COVERAGE_THRESHOLD: ${{ vars.CI_COVERAGE_MIN }}
        run: |
          if [ -z "$COVERAGE_PERCENT" ]; then
            echo "::warning::Coverage percent unavailable; skipping comment"
            exit 0
          fi

          cat <<MARKDOWN > coverage-comment.md
          <!-- coverage-report -->
          ### âœ… Coverage results

          | Metric | Value |
          | --- | --- |
          | Lines covered | ${COVERAGE_PERCENT}% |
          | Required minimum | ${COVERAGE_THRESHOLD}% |

          - Coverage artifacts uploaded with flag \`unittests\`.
          - [HTML report (latest main build)](https://bigdaddy1990.github.io/pawcontrol/coverage/latest/index.html)
          MARKDOWN

          echo "has_comment=true" >> "$GITHUB_OUTPUT"

      - name: Publish PR comment
        if: steps.summary.outputs.has_comment == 'true'
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          token: ${{ secrets.GITHUB_TOKEN }}
          body-path: coverage-comment.md
          comment-identifier: coverage-report

  coverage-pages:
    name: Publish Coverage to GitHub Pages
    needs: test-coverage
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.test-coverage.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download coverage artifact
        uses: actions/download-artifact@v7
        with:
          name: coverage-report
          path: artifacts/coverage

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Publish coverage bundle
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python -m script.publish_coverage \
            --coverage-xml artifacts/coverage/generated/coverage/coverage.xml \
            --coverage-html-index artifacts/coverage/generated/coverage/html/index.html \
            --artifact-directory artifacts/coverage/generated/coverage/artifacts \
            --mode pages \
            --pages-branch gh-pages \
            --pages-prefix coverage \
            --prune-expired-runs

  docs-diff-comment:
    name: Document change summary
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Summarise documentation & localization changes
        id: docs
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: |
          git diff --name-status "$BASE_SHA"...HEAD > changed_files.txt
          python - <<'PY'
          from __future__ import annotations

          from collections import defaultdict

          categories: dict[str, list[str]] = defaultdict(list)
          category_map = {
              "README.md": "Documentation",
              "INSTALLATION.md": "Documentation",
              "info.md": "Documentation",
              "dev.md": "Documentation",
              "docs": "Documentation",
              "docs/": "Documentation",
              "custom_components/pawcontrol/strings.json": "Localization",
              "custom_components/pawcontrol/translations": "Localization",
              "custom_components/pawcontrol/translations/": "Localization",
          }

          def categorise(path: str) -> str | None:
              for key, category in category_map.items():
                  if key.endswith("/"):
                      if path.startswith(key):
                          return category
                  elif path == key:
                      return category
              if path.startswith("docs/"):
                  return "Documentation"
              if path.startswith("custom_components/pawcontrol/translations/"):
                  return "Localization"
              if path.startswith("docs-"):
                  return "Documentation"
              return None

          changed: list[tuple[str, str]] = []
          with open("changed_files.txt", "r", encoding="utf-8") as handle:
              for line in handle:
                  line = line.strip()
                  if not line:
                      continue
                  status, file_path = line.split("\t", 1)
                  category = categorise(file_path)
                  if category is not None:
                      categories[category].append(f"{status} {file_path}")
                      changed.append((status, file_path))

          if not changed:
              with open("docs-diff-flag", "w", encoding="utf-8") as marker:
                  marker.write("false")
              raise SystemExit

          lines = ["<!-- docs-diff -->", "### ðŸ“š Documentation & localization changes", ""]
          for category in sorted(categories):
              entries = sorted(categories[category])
              lines.append(f"- **{category} ({len(entries)})**")
              for entry in entries:
                  lines.append(f"  - `{entry}`")

          lines.append("")
          lines.append(
              "Run `python -m script.sync_contributor_guides` after adjusting contributor docs to keep assistants in sync."
          )

          with open("docs-diff-comment.md", "w", encoding="utf-8") as outfile:
              outfile.write("\n".join(lines) + "\n")

          with open("docs-diff-flag", "w", encoding="utf-8") as marker:
              marker.write("true")
          PY
          if [ -f docs-diff-flag ] && [ "$(cat docs-diff-flag)" = "true" ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish PR comment
        if: steps.docs.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          token: ${{ secrets.GITHUB_TOKEN }}
          body-path: docs-diff-comment.md
          comment-identifier: docs-diff


  localization-guards:
    name: Localization & Guide Sync
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements.txt

      - name: Validate localization tables and contributor guides
        env:
          PYTHONPATH: .
        run: |
          python -m script.sync_localization_flags \
            --allowlist script/sync_localization_flags.allowlist \
            --check
          python -m script.sync_contributor_guides --check

  mypy-config:
    name: Type Check Config Flows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements.txt

      - name: Install mypy
        run: |
          python -m pip install --upgrade pip
          pip install mypy

      - name: Run mypy for configuration modules
        run: |
          mypy --follow-imports=skip \
            custom_components/pawcontrol/config_flow.py \
            custom_components/pawcontrol/config_flow_base.py \
            custom_components/pawcontrol/config_flow_dogs.py \
            custom_components/pawcontrol/options_flow.py \
            custom_components/pawcontrol/config_flow_modules.py \
            custom_components/pawcontrol/config_flow_external.py \
            custom_components/pawcontrol/config_flow_dashboard_extension.py \
            custom_components/pawcontrol/config_flow_profile.py

      - name: Run mypy for telemetry modules
        run: |
          mypy --follow-imports=skip \
            custom_components/pawcontrol/repairs.py \
            custom_components/pawcontrol/types.py \
            custom_components/pawcontrol/coordinator_tasks.py \
            custom_components/pawcontrol/performance.py \
            custom_components/pawcontrol/services.py \
            custom_components/pawcontrol/telemetry.py

  validate-manifest:
    name: Validate Manifest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate manifest.json
        run: |
          python -c "
          import json
          import sys

          with open('custom_components/pawcontrol/manifest.json', 'r') as f:
              manifest = json.load(f)

          required = ['domain', 'name', 'version', 'documentation', 'codeowners', 'requirements']
          missing = [field for field in required if field not in manifest]

          if missing:
              print(f'Missing required fields: {missing}')
              sys.exit(1)

          print('âœ… Manifest validation passed')
          "

  marketplace-validation:
    name: Hassfest & HACS validation
    uses: ./.github/workflows/reusable-marketplace-validation.yml
    with:
      category: integration
      ignore: brands

  all-checks:
    name: All Checks Passed
    if: always()
    needs:
      [lint, typed-dict-audit, test-coverage, code-quality, localization-guards, mypy-config, validate-manifest, marketplace-validation]
    runs-on: ubuntu-latest
    steps:
      - name: Summarise upstream results
        run: |
          cat <<'SUMMARY'
          typed-dict-audit: ${{ needs.typed-dict-audit.result }}
          lint: ${{ needs.lint.result }}
          test-coverage: ${{ needs.test-coverage.result }}
          code-quality: ${{ needs.code-quality.result }}
          localization-guards: ${{ needs.localization-guards.result }}
          mypy-config: ${{ needs.mypy-config.result }}
          validate-manifest: ${{ needs.validate-manifest.result }}
          marketplace-validation: ${{ needs.marketplace-validation.result }}
          SUMMARY

      - name: Fail when any prerequisite did not succeed
        if: ${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'skipped') }}
        run: |
          echo "âŒ At least one required job did not complete successfully." >&2
          exit 1

      - name: Confirm success
        if: ${{ !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled') && !contains(needs.*.result, 'skipped') }}
        run: echo "âœ… All prerequisite checks succeeded"
