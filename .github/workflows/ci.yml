name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  hassfest:
    name: Hassfest
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - uses: home-assistant/actions/hassfest@master

  hacs:
    name: HACS Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
      - uses: hacs/action@main
        with:
          category: integration
          ignore: brands
          repository: ${{ github.repository }}

  tests:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.14"]

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements_test.txt
          python -m pip install --upgrade ruff mypy pre-commit pytest pytest-cov coverage[toml]
          pip install homeassistant || true
          pip install -r requirements.txt

      # Update output format to enable automatic inline annotations.
      - name: Ruff lint
        run: ruff check --fix --exit-non-zero-on-fix --output-format=github . ||  true

      - name: Verify contributor guides
        run: python -m scripts.sync_contributor_guides --check

      - name: Check legacy exception syntax
        run: python -m scripts.check_legacy_exception_syntax custom_components/pawcontrol

      - name: Run policy scripts
        run: |
          python -m scripts.enforce_docstring_baseline --update
          python -m scripts.enforce_test_requirements
          python -m scripts.sync_localization_flags --check

      - name: Run pre-commit
        run: pre-commit run --all-files --show-diff-on-failure

      - name: Run mypy
        run: mypy custom_components/pawcontrol --show-error-codes || true

      - name: Run hassfest shim
        run: python -m scripts.hassfest --integration-path custom_components/pawcontrol

      - name: Run tests and collect coverage
        env:
          PYTHONPATH: .
        run: |
          pytest \
            --cov=custom_components/pawcontrol \
            --cov-branch \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --junitxml=junit.xml \
            -o junit_family=legacy \
            -q \
            --maxfail=20 \
            tests/ || true

      - name: Upload coverage to Codecov
        id: codecov_coverage_upload
        uses: codecov/codecov-action@v5
        with:
          use_oidc: true
          files: coverage.xml
          fail_ci_if_error: false
          disable_search: true
          flags: unittests
          name: pawcontrol-coverage

      - name: Retry coverage upload to Codecov when primary upload fails
        if: ${{ always() && !cancelled() && steps.codecov_coverage_upload.outcome == 'failure' }}
        uses: codecov/codecov-action@v5
        with:
          use_oidc: true
          files: coverage.xml
          fail_ci_if_error: false
          disable_search: true
          flags: unittests
          name: pawcontrol-coverage-retry

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@v5
        with:
          use_oidc: true
          files: junit.xml
          report_type: test_results
          disable_search: true
          fail_ci_if_error: false
