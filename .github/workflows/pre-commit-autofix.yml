name: Pre-commit Autofix

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  autofix:
    name: Apply pre-commit fixes (same-repo PRs)
    runs-on: ubuntu-latest
    if: >-
      github.actor != 'github-actions[bot]' &&
      (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ vars.PYTHON_VERSION != '' && vars.PYTHON_VERSION || '3.13' }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements_test.txt
            pyproject.toml
            .pre-commit-config.yaml

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          python -m pip install pre-commit

      - name: Run pre-commit (apply fixes)
        id: precommit
        continue-on-error: true
        run: |
          pre-commit run --all-files --show-diff-on-failure

      - name: Commit & push changes
        if: github.event_name == 'pull_request'
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore(pre-commit): autofix"
          git push

      - name: Re-run pre-commit (must be clean)
        run: |
          pre-commit run --all-files --show-diff-on-failure
