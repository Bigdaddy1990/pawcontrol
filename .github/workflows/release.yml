name: Release Automation

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: '3.14'

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREVIOUS_TAG_COMMIT=$(git rev-list --tags --skip=1 --max-count=1)
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags "$PREVIOUS_TAG_COMMIT" 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            COMMITS=$(git log "$PREVIOUS_TAG"..HEAD --pretty=format:"- %s (%h)" --reverse)
          fi

          # Create changelog
          cat > CHANGELOG.md << EOF
          # Release ${{ steps.version.outputs.version }}

          ## Changes

          $COMMITS

          ## Installation

          \`\`\`yaml
          # Via HACS (recommended)
          1. Open HACS â†’ Integrations
          2. Search for "PawControl"
          3. Click Download

          # Manual
          1. Download pawcontrol.tar.gz
          2. Extract to custom_components/
          3. Restart Home Assistant
          \`\`\`

          ## Verification

          SHA256: \$(sha256sum dist/pawcontrol.tar.gz | cut -d' ' -f1)
          EOF

          cat CHANGELOG.md

      - name: Create package
        run: |
          mkdir -p dist
          cp -r custom_components/pawcontrol dist/
          cd dist
          tar -czf pawcontrol.tar.gz pawcontrol/
          sha256sum pawcontrol.tar.gz > pawcontrol.tar.gz.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          files: |
            dist/pawcontrol.tar.gz
            dist/pawcontrol.tar.gz.sha256
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'rc') || contains(steps.version.outputs.version, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update HACS repository
        if: ${{ !contains(steps.version.outputs.version, 'rc') && !contains(steps.version.outputs.version, 'beta') }}
        run: |
          echo "Stable release ${{ steps.version.outputs.version }} created"
          # HACS will automatically detect the new release
