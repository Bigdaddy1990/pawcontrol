name: Python Tests with Coverage

on:
  workflow_call:
    inputs:
      python-version:
        description: Python version to install
        required: false
        type: string
        default: "3.14"
      home-assistant-spec:
        description: Version specifier for Home Assistant (e.g. ==2025.9.3 or >=2025.9.0)
        required: false
        type: string
        default: ">=2025.9.0"
      coverage-min:
        description: Minimum coverage percentage required to pass (e.g. "80")
        required: false
        type: string
        default: ""
      run-codecov:
        description: Upload coverage and test results to Codecov
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  tests:
    runs-on: ubuntu-latest

    env:
      PYTHON_VERSION: ${{ inputs.python-version }}
      HA_SPEC: ${{ inputs.home-assistant-spec }}
      UV_SYSTEM_PYTHON: "1"

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@c6295a65d1254861815972266d5933fd6e532bdf # v2.11.1
        with:
          egress-policy: audit

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv (with cache)
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies (uv)
        run: |
          uv --version
          uv pip install --system -r requirements.txt
          uv pip install --system -r requirements_test.txt
          uv pip install --system "homeassistant${HA_SPEC}"
          uv cache prune --ci

      - name: Ruff (check)
        run: |
          ruff --version
          ruff format --check .
          ruff check .

      - name: Run mypy
        run: |
          mypy custom_components/pawcontrol

      - name: Run hassfest shim
        run: |
          python -m scripts.hassfest --integration-path custom_components/pawcontrol

      - name: Run pytest
        run: |
          pytest -q --disable-warnings --maxfail=20 \
            --cov=custom_components/pawcontrol \
            --cov-report=term-missing \
            --cov-report=xml

      - name: Enforce coverage threshold
        if: ${{ inputs.coverage-min != '' }}
        run: |
          python - <<'PY'
          import sys, xml.etree.ElementTree as ET
          min_cov = float("${{ inputs.coverage-min }}")
          root = ET.parse("coverage.xml").getroot()
          rate = float(root.attrib.get("line-rate", "0")) * 100.0
          print(f"Coverage: {rate:.2f}% (min {min_cov:.2f}%)")
          sys.exit(0 if rate + 1e-9 >= min_cov else 1)
          PY

      - name: Codecov
        if: ${{ inputs.run-codecov }}
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
